<div class="container">
  <h1>Jewellers Block Insurance Application</h1>

  <!-- Step Indicator -->
  <div class="step-indicator">
    <div class="step" [class.active]="currentStep === 1" [class.completed]="currentStep > 1">
      <div class="step-number">1</div>
      <div class="step-title">Account Details</div>
    </div>
    <div class="step" [class.active]="currentStep === 2" [class.completed]="currentStep > 2">
      <div class="step-number">2</div>
      <div class="step-title">Exposure Information</div>
    </div>
    <div class="step" [class.active]="currentStep === 3" [class.completed]="currentStep > 3">
      <div class="step-number">3</div>
      <div class="step-title">Travel & History</div>
    </div>
    <div class="step" [class.active]="currentStep === 4" [class.completed]="currentStep > 4">
      <div class="step-number">4</div>
      <div class="step-title">Coverage Information</div>
    </div>
    <div class="step" [class.active]="currentStep === 5" [class.completed]="currentStep > 5">
      <div class="step-number">5</div>
      <div class="step-title">Risk Assessment & Loss History</div>
    </div>
    <div class="step" [class.active]="currentStep === 6" [class.completed]="currentStep > 6">
      <div class="step-number">6</div>
      <div class="step-title">Review & Submit</div>
    </div>
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <!-- Step 1: Firm Details -->
  <div class="card" *ngIf="currentStep === 1">
    <h2>1. Account Details</h2>
    <div class="form-group">
      <label>Assured *</label>
      <input type="text" [(ngModel)]="payload.firm_name" required />
    </div>
    <div class="form-group">
      <label>Country / Territory</label>
      <select [(ngModel)]="payload.country" (change)="onTerritoryChange()">
        <option [value]="undefined">Select</option>
        <option *ngFor="let t of territoryOptions" [value]="t">{{ t }}</option>
      </select>
    </div>
    <div class="form-group">
      <label>Currency</label>
      <input type="text" [(ngModel)]=" payload.currency" disabled="true" />
    </div>
    <div class="form-group">
      <label>Exchange Rate</label>
      <input type="number" [(ngModel)]="payload.exRate" #exRate="ngModel" required />
      <div *ngIf="exRate.touched && !payload.exRate" class="text-danger">
        Exchange Rate cannot be zero or blank
      </div>
    </div>
     <div class="form-group">
      <label>CAD Limit</label>
      <input type="text" [ngModel]="payload.cadLimit | number:'1.0-0'" (ngModelChange)="payload.cadLimit = parseCurrency($event)" [ngModelOptions]="{updateOn: 'blur'}" />
    </div>
     <div class="form-group">
      <label>CAD Excess</label>
      <input type="text" [ngModel]="payload.cadExcess | number:'1.0-0'" (ngModelChange)="payload.cadExcess = parseCurrency($event)" [ngModelOptions]="{updateOn: 'blur'}" />
    </div>
    <div class="form-group">
      <label>USD Limit</label>
      <input type="text" [value]="((payload.cadLimit || 0) * (payload.exRate || 0)) | number:'1.0-0'" disabled />
    </div>
    <div class="form-group">
      <label>USD Excess</label>
      <input type="text" [value]="((payload.cadExcess || 0) * (payload.exRate || 0)) | number:'1.0-0'" disabled />
    </div>
    <div class="form-group">
      <label>Business Type</label>
      <select [(ngModel)]="payload.business_type">
        <option [value]="undefined">Select</option>
        <option *ngFor="let type of businessTypeOptions" [value]="type">{{ type }}</option>
      </select>
    </div>
    <div class="form-group">
      <label>Dropdown Clause</label>
      <select [(ngModel)]="payload.dropdown_clause">
        <option [value]="undefined">Select</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
    </div>
    <div class="form-group">
      <label>Total Discounts</label>
      <input type="number" [(ngModel)]=" payload.totalDiscounts" />
    </div>
  </div>
    




    

  <!-- Step 2: Business & Employees -->
  <div class="card" *ngIf="currentStep === 2">
    <h2>2. Exposure Information</h2>
    <h3> Premises Exposure</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Label</th>
          <th>Limit</th>
          <th>Value</th>
          <th>Premium</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let layer of layers; let i = index">
          <td>{{ layer.label }}</td>
          <td>{{ i === layers.length - 1 ? '> 5m' : (layer.limit | currency:'USD':'symbol':'1.0-0') }}</td>
          <td>{{(layer.exposure | currency:'USD':'symbol':'1.0-0')}}</td>
          <td>{{(layer.premium | currency:'USD':'symbol':'1.0-0')}}</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3" style="text-align: right; font-weight: bold;">Total Premium</td>
          <td style="font-weight: bold;">{{ calculateTotalExposurePremium() | currency:'USD':'symbol':'1.0-0' }}</td>
        </tr>
      </tfoot>
    </table>

    <h3>Additional Coverages</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Label</th>
          <th>Limit</th>
          <th>Premium</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let layer of otherLayers; let i = index">
          <td>{{ layer.label }}</td>
          <td><input type="text" [ngModel]="layer.limit | number:'1.0-0'" (ngModelChange)="updateOtherLayerLimit(layer, $event)" [ngModelOptions]="{updateOn: 'blur'}" /></td>
          <td>{{(layer.premium | currency:'USD':'symbol':'1.0-0')}}</td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="2" style="text-align: right; font-weight: bold;">Total Premium</td>
          <td style="font-weight: bold;">{{ calculateOtherExposureTotalPremium() | currency:'USD':'symbol':'1.0-0' }}</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Step 3: Losses & History -->
  <div class="card" *ngIf="currentStep === 3">
    <h2>3. Travel & History</h2>
    <h3>Peak Season</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Description</th>
          <th>Limit</th>
          <th>Number of Days</th>
          <th>Rate</th>
          <th>Premium</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Increase In Limit</td>
          <td>
            <div class="form-group" style="margin-bottom: 0;"><input type="text" [ngModel]="payload.increase_limit_amount | number:'1.0-0'" (ngModelChange)="payload.increase_limit_amount = parseCurrency($event)" [ngModelOptions]="{updateOn: 'blur'}" style="width: 100%;" /></div>
          </td>
          <td>
            <div class="form-group" style="margin-bottom: 0;"><input type="number" [(ngModel)]="payload.increase_limit_days" style="width: 100%;" /></div>
          </td>
          <td>
            <div class="form-group" style="margin-bottom: 0;"><input type="number" [(ngModel)]="payload.peak_season_rate" step="0.01" style="width: 100%;" /></div>
          </td>
          <td>{{ calculatePeakSeasonPremium(payload) | currency:'USD':'symbol':'1.2-2' }}</td>
        </tr>
      </tbody>
    </table>


    <h3>Travel</h3>
    <div *ngFor="let item of payload.travel; let i = index" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 4px;">
      <div class="form-row">
        <div class="form-group">
          <label>Travel Type</label>
          <select [(ngModel)]="item.travel_type">
            <option [ngValue]="undefined">Select</option>
            <option *ngFor="let rate of travelPremiumRates" [value]="rate.layerId">{{ rate.label }}</option>
          </select>
        </div>
        <div class="form-group">
          <label>Limit</label>
          <input type="text" [ngModel]="item.limit | number:'1.0-0'" (ngModelChange)="item.limit = parseCurrency($event)" [ngModelOptions]="{updateOn: 'blur'}" />
        </div>
        <div class="form-group">
          <label>Number of Days</label>
          <input type="number" [(ngModel)]="item.days" min="0" />
        </div>
        <div class="form-group">
          <label>Premium</label>
          <input type="text" [value]="((item.limit || 0) * (item.days || 0) / 250 * (getTravelRate(item.travel_type) / 100)) | currency:'USD':'symbol':'1.2-2'" disabled />
        </div>
      </div>
      <button type="button" class="btn btn-secondary" (click)="removeTravel(i)">Remove</button>
    </div>
    <button type="button" class="btn btn-secondary" (click)="addTravel()">Add Travel Record</button>
    
    

    <div class="form-group" style="margin-top: 20px; display: flex; align-items: center;">
      <label style="margin-right: 10px; margin-bottom: 0;">Unattended Vehicle Load (%)</label>
      <input type="number" [(ngModel)]="payload.unattended_vehicle_load_percent" style="width: 100px;" />
    </div>

    <div class="form-group" style="text-align: right; margin-top: 20px;">
      <label style="font-weight: bold; margin-right: 10px;">Total Travel Premium:</label>
      <span style="font-weight: bold; font-size: 1.2em;">{{ calculateTotalTravePremium() | currency:'USD':'symbol':'1.2-2' }}</span>
    </div>

    <h3>Sendings</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Sendings</th>
          <th>Exposure</th>
          <th>Premium</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let layer of sendingsLayers">
          <td>{{ layer.label }}</td>
          <td>
            <div class="form-group" style="margin-bottom: 0;">
              <input type="text" [ngModel]="layer.exposure | number:'1.0-0'" (ngModelChange)="updateSendingLayerExposure(layer, $event)" [ngModelOptions]="{updateOn: 'blur'}" style="width: 100%;" />
            </div>
          </td>
          <td>{{ (layer.premium || 0) | currency:'USD':'symbol':'1.2-2' }}</td>
        </tr>
      </tbody>
    </table>

    <div class="form-group" style="text-align: right; margin-top: 20px;">
      <label style="font-weight: bold; margin-right: 10px;">Total Sendings Premium:</label>
      <span style="font-weight: bold; font-size: 1.2em;">{{ calculateTotalSendingPremium() | currency:'USD':'symbol':'1.2-2' }}</span>
    </div>

    <h3>Exhibitions</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Exhibitions</th>
          <th>Limit</th>
          <th>No of Shows</th>
          <th>Premium</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let layer of exhibitionLayers">
          <td>{{ layer.label }}</td>
          <td>
            <div class="form-group" style="margin-bottom: 0;">
              <input type="text" [ngModel]="layer.limit | number:'1.0-0'" (ngModelChange)="updateExhibitionLimit(layer, $event)" [ngModelOptions]="{updateOn: 'blur'}" style="width: 100%;" />
            </div>
          </td>
          <td>
            <div class="form-group" style="margin-bottom: 0;">
              <input type="number" [ngModel]="layer.no_of_shows" (ngModelChange)="layer.no_of_shows=$event; calculateExhibitionPremium(layer)" style="width: 100%;" />
            </div>
          </td>
          <td>{{ (layer.premium || 0) | currency:'USD':'symbol':'1.2-2' }}</td>
        </tr>
      </tbody>
    </table>
    <div class="form-group" style="text-align: right; margin-top: 20px;">
      <label style="font-weight: bold; margin-right: 10px;">Total Exhibitions Premium:</label>
      <span style="font-weight: bold; font-size: 1.2em;">{{ calculateTotalExhibitionPremium() | currency:'USD':'symbol':'1.2-2' }}</span>
    </div>

    <div class="form-group" style="text-align: right; margin-top: 20px;">
      <label style="font-weight: bold; margin-right: 10px;">Exposure Premium:</label>
      <span style="font-weight: bold; font-size: 1.2em;">{{ calculateFinalTravelPremium() | currency:'USD':'symbol':'1.2-2' }}</span>
    </div>
  </div>

  <!-- Step 4: Inventories -->
  <div class="card" *ngIf="currentStep === 4">
    <h2>4. Coverage Information</h2>
    <h3>Non-Standard Coverage</h3>
    <div *ngFor="let item of payload.nonStandardCoverage; let i = index" style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 4px;">
      <div class="form-row">
        <div class="form-group">
          <label>Type</label>
          <input type="text" [(ngModel)]="item.type" />
        </div>
        <div class="form-group">
          <label>Load/Credit (%)</label>
          <input type="number" [(ngModel)]="item.loadCredit" />
        </div>
        <div class="form-group">
          <label>Premium</label>
          <input type="text" [value]="((item.loadCredit || 0) / 100 * calculateFinalTravelPremium()) | currency:'USD':'symbol':'1.2-2'" disabled />
        </div>
      </div>
      <button type="button" class="btn btn-secondary" (click)="removeNonStandardCoverage(i)">Remove</button>
    </div>
    <button type="button" class="btn btn-secondary" (click)="addNonStandardCoverage()">Add Non-Standard Coverage</button>
    <div class="form-row" style="margin-top: 10px;">
      <div class="form-group">
        <label></label>
        <input type="text" value="Total Load / (Credit) & Premium:" disabled style="border: none; background: transparent; font-weight: bold; padding-left: 0;" />
      </div>
      <div class="form-group">
        <label>Total Load/Credit (%)</label>
        <input type="number" [value]="calculateTotalNonStandardLoadCredit()" disabled />
      </div>
      <div class="form-group">
        <label>Total Load/Credit Premium</label>
        <input type="text" [value]="calculateTotalNonStandardPremium() | currency:'USD':'symbol':'1.2-2'" disabled />
      </div>
    </div>

    <hr />
    <h3>Deductibles</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Type</th>
          <th>Amount</th>
          <th>Load/Credit (%)</th>
          <th>Premium</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of payload.deductibles">
          <td>{{ item.type }}</td>
          <td>
            <div class="form-group" style="margin-bottom: 0;">
              <input type="number" [(ngModel)]="item.amount" step="1" style="width: 100%;" />
            </div>
          </td>
          <td>
            <div class="form-group" style="margin-bottom: 0;">
              <input type="number" [(ngModel)]="item.loadCredit" style="width: 100%;" />
            </div>
          </td>
          <td>
            <input type="text" [value]="calculateDeductiblePremium(item) | currency:'USD':'symbol':'1.2-2'" disabled style="width: 100%; border: none; background: transparent;" />
          </td>
        </tr>
      </tbody>
    </table>
    <div class="form-row" style="margin-top: 10px;">
      <div class="form-group">
        <label></label>
        <input type="text" value="Total Load / (Credit) & Premium:" disabled style="border: none; background: transparent; font-weight: bold; padding-left: 0;" />
      </div>
      <div class="form-group">
        <label>Total Load/Credit (%)</label>
        <input type="number" [value]="calculateTotalDeductibleLoadCredit()" disabled />
      </div>
      <div class="form-group">
        <label>Total Load/Credit Premium</label>
        <input type="text" [value]="calculateTotalDeductiblePremium() | currency:'USD':'symbol':'1.2-2'" disabled />
      </div>
    </div>
    <div class="form-row" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
      <div class="form-group">
        <label style="font-weight: bold;">Mechanical Premium</label>
        <input type="text" [value]="calculateMechanicalPremium() | currency:'USD':'symbol':'1.2-2'" disabled style="font-weight: bold;" />
      </div>
    </div>
  </div>

  <!-- Step 5: Coverage & Limits -->
  <div class="card" *ngIf="currentStep === 5">
    <h2>5. Risk Assessment</h2>
    <h3>Adjustments</h3>
    <div class="form-group">
      <label>Percentage of exposure (%)</label>
      <input type="number" [(ngModel)]="payload.percentage_of_exposure" (ngModelChange)="updateFirstLossAdjustment()" />
    </div>

    <table class="table">
      <thead>
        <tr>
          <th>Adjustments</th>
          <th>Load/Credit (%)</th>
          <th>Premium</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of payload.adjustments; let i = index">
          <td>
            <input type="text" [(ngModel)]="item.description" style="width: 100%;" />
          </td>
          <td>
            <input type="number" [(ngModel)]="item.loadCredit" [disabled]="i === 0" style="width: 100%;" />
          </td>
          <td>
            <input type="text" [value]="calculateAdjustmentPremium(item) | currency:'USD':'symbol':'1.2-2'" disabled style="width: 100%; border: none; background: transparent;" />
          </td>
          <td><button type="button" class="btn btn-secondary" (click)="removeAdjustment(i)" *ngIf="i >= 4">Remove</button></td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <td style="font-weight: bold;">Total Load / Credit & Premium:</td>
          <td>
            <input type="number" [value]="calculateTotalAdjustmentLoadCredit()" disabled style="width: 100%; font-weight: bold;" />
          </td>
          <td>
            <input type="text" [value]="calculateTotalAdjustmentPremium() | currency:'USD':'symbol':'1.2-2'" disabled style="width: 100%; border: none; background: transparent; font-weight: bold;" />
          </td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    <button type="button" class="btn btn-secondary" (click)="addAdjustment()">Add Adjustment</button>

    <h3>Loss History</h3>
    <table class="table">
      <thead>
        <tr>
          <th>Loss Ratio</th>
          <th>Percentage</th>
          <th>Load/Credit</th>
          <th>Premium</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Loss Ratio</td>
          <td><input type="number" [(ngModel)]="payload.loss_history_percentage" style="width: 100%;" /></td>
          <td><input type="number" [(ngModel)]="payload.loss_history_load_credit" style="width: 100%;" /></td>
          <td><input type="text" [value]="calculateLossHistoryPremium() | currency:'USD':'symbol':'1.2-2'" disabled style="width: 100%; border: none; background: transparent;" /></td>
        </tr>
      </tbody>
    </table>
   
    <div class="form-row" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
      <div class="form-group">
        <label style="font-weight: bold;">Technical Premium</label>
        <input type="text" [value]="calculateTechnicalPremium() | currency:'USD':'symbol':'1.2-2'" disabled style="font-weight: bold;" />
      </div>
    </div>

     <h3>Premium</h3>
     <div class="form-group">
       <label>Custom Discount (%)</label>
       <input type="number" [(ngModel)]="payload.custom_discount" />
     </div>
     <table class="table">
      <thead>
        <tr>
          <th>Label</th>
          <th>Premium in CAD</th> 
          <th>Mechanical Premium</th>
          <th>Ratio</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Sold Premium with Total Discounts of {{payload.totalDiscounts}}%</td>
          <td><input type="text" [value]="calculateFinalTravelPremium() | currency:'USD':'symbol':'1.2-2'" disabled style="width: 100%; border: none; background: transparent;" /></td>
          <td><input type="text" [value]="calculateMechanicalPremium() | currency:'USD':'symbol':'1.2-2'" disabled style="width: 100%; border: none; background: transparent;" /></td>
          <td><input type="text" [value]="((calculateFinalTravelPremium() * (1 - (payload.totalDiscounts || 0)/100) / (1 - (payload.custom_discount || 0)/100)) / (calculateMechanicalPremium() || 1)) | number:'1.2-2'" disabled style="width: 100%; border: none; background: transparent;" /></td>
        </tr>
        <tr>
          <td>Premium with {{payload.custom_discount}}% Total Discounts</td>
          <td><input type="text" [value]="(calculateFinalTravelPremium() * (1 - (payload.totalDiscounts || 0)/100) / (1 - (payload.custom_discount || 0)/100)) | currency:'USD':'symbol':'1.2-2'" disabled style="width: 100%; border: none; background: transparent;" /></td>
          <td><input type="text" [value]="calculateTechnicalPremium() | currency:'USD':'symbol':'1.2-2'" disabled style="width: 100%; border: none; background: transparent;" /></td>
          <td><input type="text" [value]="((calculateFinalTravelPremium() * (1 - (payload.totalDiscounts || 0)/100) / (1 - (payload.custom_discount || 0)/100)) / (calculateTechnicalPremium() || 1)) | number:'1.2-2'" disabled style="width: 100%; border: none; background: transparent;" /></td>
        </tr>
      </tbody>
    </table>
     
    

    
  </div>

  <!-- Step 8: Review & Submit -->
  <div class="card" *ngIf="currentStep === 6">
    <h2>8. Review & Submit</h2>
    <p>Please review your application details before submitting.</p>
    
    <div style="margin: 20px 0;">
      <h3>Summary</h3>
      <p><strong>Firm Name:</strong> {{ payload.firm_name || 'Not provided' }}</p>
      <p><strong>Total Stock Value:</strong> {{ calculateTotalStockValue() }}</p>
      <p><strong>Annual Gross Revenue:</strong> {{ payload.annual_gross_revenue}}</p>
    </div>

    <div class="form-group">
      <label>Insurance Start Date</label>
      <input type="date" [(ngModel)]="payload.insurance_start_date" />
    </div>

    <div class="alert alert-danger" *ngIf="errorMessage">
      {{ errorMessage }}
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="step-actions">
    <button
      type="button"
      class="btn btn-secondary"
      (click)="previousStep()"
      [disabled]="currentStep === 1"
    >
      Previous
    </button>
    <button type="button" class="btn btn-info" (click)="saveProgress()" style="margin: 0 10px;">
      Save
    </button>
    <button
      *ngIf="currentStep < totalSteps"
      type="button"
      class="btn btn-primary"
      (click)="nextStep()"
      [class.step-invalid]="currentStep === 1 && !isStep1Valid()"
      [disabled]="currentStep === 1 && !isStep1Valid()"
    >
      Next
    </button>
    <button
      *ngIf="currentStep === totalSteps"
      type="button"
      class="btn btn-success"
      (click)="onSubmit()"
      [disabled]="loading"
    >
      {{ loading ? 'Submitting...' : 'Submit & Get Quote' }}
    </button>
  </div>
</div>
