<!DOCTYPE html>
<html>
<head>
    <title>Address Validator & Street View</title>
    <link rel="stylesheet" type="text/css" href="https://ws1.postescanada-canadapost.ca/css/addresscomplete-2.50.min.css?key=nw26-hk95-gk49-kd66" />
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        .search-section { margin-bottom: 25px; }
        input[type="text"] { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        .address-grid { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .full-width { grid-column: span 3; }
        
        #map-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 400px; margin-top: 20px; }
        #map, #street-view { border-radius: 8px; border: 1px solid #eee; }
        
        .error { color: #d9534f; font-weight: bold; padding: 10px; background: #fdf7f7; border-radius: 4px; display: none; margin-bottom: 15px; }
        label { font-size: 0.9rem; color: #666; font-weight: 600; }

    </style>
</head>
<body>

    <div class="container">
        <h2>Property Location Details</h2>
        
        <div class="search-section">
            <label>Search Address</label>
            <input type="text" id="address-search" placeholder="Start typing a Canadian address...">
            <button id="btn-submit" style="margin-top: 10px; padding: 10px 20px; cursor: pointer;">View on Map & Street View</button>
            <div id="error-msg" class="error">Error: Please select a valid Canadian address.</div>
        </div>
    
        <div class="address-grid">
            <div><label>Street</label><input type="text" id="street_name" readonly></div>
            <div><label>City</label><input type="text" id="city" readonly></div>
            <div><label>Province</label><input type="text" id="province" readonly></div>
            <div><label>Postal Code</label><input type="text" id="postal_code" readonly></div>
        </div>
    
        <div id="map-row">
            <div id="map"></div>
            <div id="street-view"></div>
        </div>
    </div>
    
    <script type="text/javascript" src="https://ws1.postescanada-canadapost.ca/js/addresscomplete-2.50.min.js?key=nw26-hk95-gk49-kd66"></script>    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlU9x3Z7krumC5n-6xoVgBhcaGCBzRcR8&callback=initApp" async defer></script>

    <script>
        let map, panorama, geocoder, AdvancedMarkerElement;
        let selectedAddressString = ""; // Store the address here

        async function initApp() {
            // Load Libraries
            const { Map } = await google.maps.importLibrary("maps");
            const { AdvancedMarkerElement: AMElement } = await google.maps.importLibrary("marker");
            AdvancedMarkerElement = AMElement;

            // Initialize Map & Street View (start empty or with a default city)
            map = new Map(document.getElementById("map"), { zoom: 15, center: {lat: 45.4215, lng: -75.6972}, mapId: "DEMO_MAP_ID" });
            panorama = new google.maps.StreetViewPanorama(document.getElementById("street-view"));
            geocoder = new google.maps.Geocoder();

            // Canada Post Autocomplete
            if (typeof pca !== 'undefined') {
                const control = new pca.Address([{ element: "address-search", field: "Line1" }], { key: "nw26-hk95-gk49-kd66" });

                control.listen("populate", (address) => {
                    if (address.CountryIso2 !== "CA") {
                        document.getElementById("error-msg").style.display = "block";
                        return;
                    }
                    document.getElementById("error-msg").style.display = "none";

                    // Fill the text fields
                    document.getElementById('street_name').value = address.Line1;
                    document.getElementById('city').value = address.City;
                    document.getElementById('province').value = address.ProvinceName;
                    document.getElementById('postal_code').value = address.PostalCode;

                    // SAVE the address string, but don't update the map yet
                    selectedAddressString = `${address.Line1}, ${address.City}, ${address.ProvinceName}, ${address.PostalCode}`;
                });
            }

            // THE TRIGGER: Add event listener to the button
            document.getElementById('btn-submit').addEventListener('click', function() {
                if (selectedAddressString !== "") {
                    updateVisuals(selectedAddressString);
                } else {
                    alert("Please select an address from the search box first.");
                }
            });
        }

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function updateVisuals(addressString) {
        // Start by geocoding the address
        geocoder.geocode({ address: addressString }, async (results, status) => {
            if (status === "OK") {
                const loc = results[0].geometry.location;

                // 2. Update Map and Marker first
                map.setCenter(loc);
                new AdvancedMarkerElement({
                    map: map,
                    position: loc,
                    title: addressString
                });

                // 3. THE FIX: Wait exactly 100ms before hitting the Street View API
                console.log("Geocode success. Waiting 100ms before Street View...");
             //   await delay(500); 
                
                // 4. Update Street View with Availability Check
                const streetViewService = new google.maps.StreetViewService();
               
                // Search for imagery within 50 meters of the address
                streetViewService.getPanorama({ location: loc, radius: 50 }, (data, svStatus) => {
                if (svStatus === "OK" && panorama) {
                    console.log("Street View imagery found. Updating panorama...");
                    panorama.setPano(data.location.pano);
                    panorama.setPov({ heading: 180, pitch: 0 });
                    panorama.setVisible(true);
                    console.log("Street View updated successfully.");
                } else {
                    console.warn("No Street View imagery found within 50m of this location.");
                    // Optional: Hide the panorama or show a "No Image" placeholder
                    if (panorama) panorama.setVisible(false);
                }
            });
            } else if (status === "OVER_QUERY_LIMIT") {
                // Fallback: If still throttled, wait 2 seconds and try one last time
                console.warn("Throttled! Retrying in 2 seconds...");
                setTimeout(() => updateVisuals(addressString), 2000);
            }
        });
    }
    </script>
</body>
</html>
