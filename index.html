<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Address Intelligence Pro | Street-Snap Version</title>
    <link rel="stylesheet" type="text/css" href="https://ws1.postescanada-canadapost.ca/css/addresscomplete-2.50.min.css?key=nw26-hk95-gk49-kd66" />
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body { font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; line-height: 1.5; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        
        .header { margin-bottom: 25px; border-bottom: 1px solid #e2e8f0; padding-bottom: 20px; }
        h2 { margin: 0 0 15px 0; color: var(--text); }
        .search-area { max-width: 600px; }
        input[type="text"] { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; transition: border 0.2s; box-sizing: border-box; }
        input[type="text"]:focus { border-color: var(--primary); outline: none; }

        .address-grid { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 15px; margin: 25px 0; }
        label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 6px; display: block; }
        input[readonly] { background: #f1f5f9; border: 1px dashed #cbd5e1; color: #475569; }

        .viewer-container { position: relative; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 500px; margin-top: 25px; }
        #map, #street-view { border-radius: 12px; border: 1px solid #e2e8f0; background: #e5e7eb; }
        
        .button-group { display: flex; gap: 12px; margin-top: 15px; }
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; transition: all 0.2s; text-decoration: none; font-size: 0.9rem; display: inline-flex; align-items: center; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        #loader { 
            position: absolute; inset: 0; background: rgba(255,255,255,0.8); 
            display: none; justify-content: center; align-items: center; z-index: 100; border-radius: 12px;
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .error-msg { color: #ef4444; font-size: 0.85rem; margin-top: 10px; display: none; font-weight: 500; }

        @media (max-width: 900px) { .viewer-container { grid-template-columns: 1fr; height: auto; } #map, #street-view { height: 350px; } .address-grid { grid-template-columns: 1fr 1fr; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h2>Property Location Detailer</h2>
            <div class="search-area">
                <label>Canadian Address Search</label>
                <input type="text" id="address-search" placeholder="Start typing address...">
                <div class="button-group">
                    <button id="btn-submit" class="btn btn-primary">Update Viewers</button>
                    <a id="btn-external" href="#" target="_blank" class="btn btn-outline" style="display: none;">Open in Google Maps â†—</a>
                </div>
                <div id="error-msg" class="error-msg"></div>
            </div>
        </div>

        <div class="address-grid">
            <div><label>Street</label><input type="text" id="street_name" readonly></div>
            <div><label>City</label><input type="text" id="city" readonly></div>
            <div><label>Province</label><input type="text" id="province" readonly></div>
            <div><label>Postal Code</label><input type="text" id="postal_code" readonly></div>
        </div>

        <div class="viewer-container">
            <div id="loader"><div class="spinner"></div></div>
            <div id="map"></div>
            <div id="street-view"></div>
        </div>
    </div>

    <script src="https://ws1.postescanada-canadapost.ca/js/addresscomplete-2.50.min.js?key=nw26-hk95-gk49-kd66"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlU9x3Z7krumC5n-6xoVgBhcaGCBzRcR8&libraries=geometry,marker&callback=initApp" async defer></script>

    <script>
        let map, panorama, geocoder, AdvancedMarkerElement;
        let selectedFullAddress = "";

        async function initApp() {
            try {
                const { Map } = await google.maps.importLibrary("maps");
                const { AdvancedMarkerElement: AM } = await google.maps.importLibrary("marker");
                AdvancedMarkerElement = AM;

                map = new Map(document.getElementById("map"), {
                    zoom: 15, 
                    center: {lat: 43.6532, lng: -79.3832}, 
                    mapId: "DEMO_MAP_ID"
                });

                panorama = new google.maps.StreetViewPanorama(document.getElementById("street-view"), {
                    visible: false,
                    addressControl: true
                });

                geocoder = new google.maps.Geocoder();

                if (typeof pca !== 'undefined') {
                    const control = new pca.Address([{ element: "address-search", field: "Line1" }], { key: "nw26-hk95-gk49-kd66" });
                    control.listen("populate", (address) => {
                        document.getElementById('street_name').value = address.Line1;
                        document.getElementById('city').value = address.City;
                        document.getElementById('province').value = address.ProvinceName;
                        document.getElementById('postal_code').value = address.PostalCode;
                        selectedFullAddress = `${address.Line1}, ${address.City}, ${address.ProvinceName}, ${address.PostalCode}`;
                    });
                }
            } catch (e) { console.error(e); }
        }

        document.getElementById('btn-submit').addEventListener('click', () => {
            if (selectedFullAddress) updateVisuals(selectedFullAddress);
        });

        async function updateVisuals(addressString) {
            const loader = document.getElementById('loader');
            const errorDiv = document.getElementById('error-msg');
            const externalBtn = document.getElementById('btn-external');

            loader.style.display = 'flex';
            errorDiv.style.display = 'none';

            try {
                // 1. CLEAN ADDRESS
                const searchString = addressString.replace(/(Suite|Unit|Apt|#|U)\s*\d+[,-\s]*/i, '').trim();

                // 2. GEOCODE ROOFTOP
                const geoResponse = await new Promise((res, rej) => {
                    geocoder.geocode({ address: searchString }, (r, s) => s === "OK" ? res(r[0]) : rej(s));
                });
                const rooftopLoc = geoResponse.geometry.location;

                // 3. UPDATE MAP
                map.setCenter(rooftopLoc);
                map.setZoom(19);
                new AdvancedMarkerElement({ map, position: rooftopLoc });

                // 4. EXTERNAL LINK
                externalBtn.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addressString)}`;
                externalBtn.style.display = 'inline-flex';

                // 5. THE "SNAPPING" FIX
                // First, find the nearest official Google Street View Panorama
                const svService = new google.maps.StreetViewService();
                
                const svData = await new Promise((resolve, reject) => {
                    svService.getPanorama({
                        location: rooftopLoc,
                        radius: 100,
                        source: google.maps.StreetViewSource.GOOGLE, // Official imagery only
                        preference: google.maps.StreetViewPreference.BEST // Prefer road-side
                    }, (data, status) => {
                        if (status === "OK") resolve(data);
                        else reject(status);
                    });
                });

                // 6. CALCULATE POV
                // Heading: Calculate angle from the car position to the building center
                const heading = google.maps.geometry.spherical.computeHeading(
                    svData.location.latLng, 
                    rooftopLoc
                );

                // Pitch: Look slightly up for skyscrapers if we are very close
                const distance = google.maps.geometry.spherical.computeDistanceBetween(svData.location.latLng, rooftopLoc);
                const pitch = distance < 25 ? 10 : 0; 

                panorama.setPano(svData.location.pano);
                panorama.setPov({ heading: heading, pitch: pitch });
                panorama.setVisible(true);

            } catch (err) {
                console.warn("SV Logic Error:", err);
                errorDiv.innerText = "Official street imagery not found. Showing overhead map only.";
                errorDiv.style.display = "block";
                if (panorama) panorama.setVisible(false);
            } finally {
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>
